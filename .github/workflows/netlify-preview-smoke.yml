name: Netlify Preview Smoke Test

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  wait-and-smoke:
    runs-on: ubuntu-latest
    env:
      NETLIFY_API_BASE: https://api.netlify.com/api/v1
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure jq is available
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate required secrets
        run: |
          if [ -z "${{ secrets.NETLIFY_AUTH_TOKEN }}" ]; then echo 'Missing NETLIFY_AUTH_TOKEN secret' && exit 1; fi
          if [ -z "${{ secrets.NETLIFY_SITE_ID }}" ]; then echo 'Missing NETLIFY_SITE_ID secret' && exit 1; fi

      - name: Poll Netlify for deploy preview URL
        id: get_preview
        run: |
          PR_BRANCH="${{ github.head_ref }}"
          echo "Looking up Netlify deploy for branch: $PR_BRANCH"
          AUTH_HEADER="Authorization: Bearer $NETLIFY_AUTH_TOKEN"

          ATTEMPTS=60
          SLEEP=10
          PREVIEW_URL=""

          for i in $(seq 1 $ATTEMPTS); do
            echo "Attempt $i/$ATTEMPTS"
            # Query latest deploys for the site
            res=$(curl -s -H "$AUTH_HEADER" "$NETLIFY_API_BASE/sites/$NETLIFY_SITE_ID/deploys")
            if [ -z "$res" ]; then echo "Empty response from Netlify API"; sleep $SLEEP; continue; fi

            # Try to find a deploy that matches the PR branch and is ready
            preview=$(echo "$res" | jq -r --arg BR "$PR_BRANCH" '.[] | select(.branch == $BR) | select(.state == "ready") | .ssl_url' | head -n1)
            if [ -n "$preview" ] && [ "$preview" != "null" ]; then
              PREVIEW_URL="$preview"
              echo "Found ready preview: $PREVIEW_URL"
              break
            fi

            # If not ready yet, also capture building deploy url to show progress
            building=$(echo "$res" | jq -r --arg BR "$PR_BRANCH" '.[] | select(.branch == $BR) | select(.state == "building") | .deploy_url' | head -n1)
            if [ -n "$building" ] && [ "$building" != "null" ]; then
              echo "Found building deploy: $building"
            fi

            sleep $SLEEP
          done

          if [ -z "$PREVIEW_URL" ]; then echo "Timed out waiting for Netlify preview for branch $PR_BRANCH" && exit 1; fi
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: Run smoke test against preview
        run: |
          URL="${{ steps.get_preview.outputs.preview_url }}"
          echo "Testing $URL"

          # Check root returns 200
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/")
          echo "Root status: $HTTP_STATUS"
          if [ "$HTTP_STATUS" -ne 200 ]; then echo "Smoke test failed: root returned $HTTP_STATUS" && exit 1; fi

          # Check DB health endpoint
          DB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/api/db-check")
          echo "/api/db-check status: $DB_STATUS"
          if [ "$DB_STATUS" -ne 200 ]; then echo "Smoke test failed: /api/db-check returned $DB_STATUS" && exit 1; fi

          # Check admin system health endpoint (may be auth-protected)
          ADMIN_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/api/admin/system/health")
          echo "/api/admin/system/health status: $ADMIN_STATUS"
          if [ "$ADMIN_STATUS" -eq 200 ]; then
            echo "Admin system health OK"
          elif [ "$ADMIN_STATUS" -eq 401 ]; then
            echo "Admin system health requires authentication (401). Treating as reachable."
          else
            echo "Smoke test failed: /api/admin/system/health returned $ADMIN_STATUS" && exit 1
          fi

          echo "Smoke test passed"

      - name: Run Playwright preview login test
        env:
          PREVIEW_URL: ${{ steps.get_preview.outputs.preview_url }}
          PREVIEW_ADMIN_EMAIL: ${{ secrets.PREVIEW_ADMIN_EMAIL }}
          PREVIEW_ADMIN_PASSWORD: ${{ secrets.PREVIEW_ADMIN_PASSWORD }}
          PREVIEW_SESSION_COOKIE: ${{ secrets.PREVIEW_SESSION_COOKIE }}
          PREVIEW_LOGIN_PATH: ${{ secrets.PREVIEW_LOGIN_PATH }}
        run: |
          corepack enable && corepack prepare pnpm@latest --activate
          pnpm init -y --silent
          pnpm add -D @playwright/test@1.41.0 playwright@1.41.0 --silent
          npx playwright install --with-deps
          # Run the single test file
          npx playwright test tests/e2e/preview-login.spec.ts --config=./node_modules/@playwright/test/lib/cli/test/config.js --reporter=list
